{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nconst info = <const>{\n  name: \"preload\",\n  parameters: {\n    /** Whether or not to automatically preload any media files based on the timeline passed to jsPsych.run. */\n    auto_preload: {\n      type: ParameterType.BOOL,\n      pretty_name: \"Auto-preload\",\n      default: false,\n    },\n    /** A timeline of trials to automatically preload. If one or more trial objects is provided in the timeline array, then the plugin will attempt to preload the media files used in the trial(s). */\n    trials: {\n      type: ParameterType.TIMELINE,\n      pretty_name: \"Trials\",\n      default: [],\n    },\n    /**\n     * Array with one or more image files to load. This parameter is often used in cases where media files cannot#\n     * be automatically preloaded based on the timeline, e.g. because the media files are passed into an image plugin/parameter with\n     * timeline variables or dynamic parameters, or because the image is embedded in an HTML string.\n     */\n    images: {\n      type: ParameterType.STRING,\n      pretty_name: \"Images\",\n      default: [],\n      array: true,\n    },\n    /**\n     * Array with one or more audio files to load. This parameter is often used in cases where media files cannot\n     * be automatically preloaded based on the timeline, e.g. because the media files are passed into an audio plugin/parameter with\n     * timeline variables or dynamic parameters, or because the audio is embedded in an HTML string.\n     */\n    audio: {\n      type: ParameterType.STRING,\n      pretty_name: \"Audio\",\n      default: [],\n      array: true,\n    },\n    /**\n     * Array with one or more video files to load. This parameter is often used in cases where media files cannot\n     * be automatically preloaded based on the timeline, e.g. because the media files are passed into a video plugin/parameter with\n     * timeline variables or dynamic parameters, or because the video is embedded in an HTML string.\n     */\n    video: {\n      type: ParameterType.STRING,\n      pretty_name: \"Video\",\n      default: [],\n      array: true,\n    },\n    /** HTML-formatted message to be shown above the progress bar while the files are loading. */\n    message: {\n      type: ParameterType.HTML_STRING,\n      pretty_name: \"Message\",\n      default: null,\n    },\n    /** Whether or not to show the loading progress bar. */\n    show_progress_bar: {\n      type: ParameterType.BOOL,\n      pretty_name: \"Show progress bar\",\n      default: true,\n    },\n    /**\n     * Whether or not to continue with the experiment if a loading error occurs. If false, then if a loading error occurs,\n     * the error_message will be shown on the page and the trial will not end. If true, then if if a loading error occurs, the trial will end\n     * and preloading failure will be logged in the trial data.\n     */\n    continue_after_error: {\n      type: ParameterType.BOOL,\n      pretty_name: \"Continue after error\",\n      default: false,\n    },\n    /** Error message to show on the page in case of any loading errors. This parameter is only relevant when continue_after_error is false. */\n    error_message: {\n      type: ParameterType.HTML_STRING,\n      pretty_name: \"Error message\",\n      default: \"The experiment failed to load.\",\n    },\n    /**\n     * Whether or not to show a detailed error message on the page. If true, then detailed error messages will be shown on the\n     * page for all files that failed to load, along with the general error_message. This parameter is only relevant when continue_after_error is false.\n     */\n    show_detailed_errors: {\n      type: ParameterType.BOOL,\n      pretty_name: \"Show detailed errors\",\n      default: false,\n    },\n    /**\n     * The maximum amount of time that the plugin should wait before stopping the preload and either ending the trial\n     * (if continue_after_error is true) or stopping the experiment with an error message (if continue_after_error is false).\n     * If null, the plugin will wait indefintely for the files to load.\n     */\n    max_load_time: {\n      type: ParameterType.INT,\n      pretty_name: \"Max load time\",\n      default: null,\n    },\n    /** Function to be called after a file fails to load. The function takes the file name as its only argument. */\n    on_error: {\n      type: ParameterType.FUNCTION,\n      pretty_name: \"On error\",\n      default: null,\n    },\n    /** Function to be called after a file loads successfully. The function takes the file name as its only argument. */\n    on_success: {\n      type: ParameterType.FUNCTION,\n      pretty_name: \"On success\",\n      default: null,\n    },\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * **preload**\n *\n * jsPsych plugin for preloading image, audio, and video files\n *\n * @author Becky Gilbert\n * @see {@link https://www.jspsych.org/plugins/jspsych-preload/ preload plugin documentation on jspsych.org}\n */\nclass PreloadPlugin implements JsPsychPlugin<Info> {\n  static info = info;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    var success = null;\n    var timeout = false;\n    var failed_images = [];\n    var failed_audio = [];\n    var failed_video = [];\n    var detailed_errors = [];\n    var in_safe_mode = this.jsPsych.getSafeModeStatus();\n\n    // create list of media to preload //\n\n    var images = [];\n    var audio = [];\n    var video = [];\n\n    if (trial.auto_preload) {\n      var experiment_timeline = this.jsPsych.getTimeline();\n      var auto_preload = this.jsPsych.pluginAPI.getAutoPreloadList(experiment_timeline);\n      images = images.concat(auto_preload.images);\n      audio = audio.concat(auto_preload.audio);\n      video = video.concat(auto_preload.video);\n    }\n\n    if (trial.trials.length > 0) {\n      var trial_preloads = this.jsPsych.pluginAPI.getAutoPreloadList(trial.trials);\n      images = images.concat(trial_preloads.images);\n      audio = audio.concat(trial_preloads.audio);\n      video = video.concat(trial_preloads.video);\n    }\n\n    images = images.concat(trial.images);\n    audio = audio.concat(trial.audio);\n    video = video.concat(trial.video);\n\n    images = this.jsPsych.utils.unique(images.flat());\n    audio = this.jsPsych.utils.unique(audio.flat());\n    video = this.jsPsych.utils.unique(video.flat());\n\n    if (in_safe_mode) {\n      // don't preload video if in safe mode (experiment is running via file protocol)\n      video = [];\n    }\n\n    // render display of message and progress bar\n\n    var html = \"\";\n\n    if (trial.message !== null) {\n      html += trial.message;\n    }\n\n    if (trial.show_progress_bar) {\n      html += `\n            <div id='jspsych-loading-progress-bar-container' style='height: 10px; width: 300px; background-color: #ddd; margin: auto;'>\n              <div id='jspsych-loading-progress-bar' style='height: 10px; width: 0%; background-color: #777;'></div>\n            </div>`;\n    }\n\n    display_element.innerHTML = html;\n\n    const update_loading_progress_bar = () => {\n      loaded++;\n      if (trial.show_progress_bar) {\n        var percent_loaded = (loaded / total_n) * 100;\n        var preload_progress_bar = display_element.querySelector<HTMLElement>(\n          \"#jspsych-loading-progress-bar\"\n        );\n        if (preload_progress_bar !== null) {\n          preload_progress_bar.style.width = percent_loaded + \"%\";\n        }\n      }\n    };\n\n    // called if all files load successfully\n    const on_success = () => {\n      if (typeof timeout !== \"undefined\" && timeout === false) {\n        // clear timeout immediately after finishing, to handle race condition with max_load_time\n        this.jsPsych.pluginAPI.clearAllTimeouts();\n        // need to call cancel preload function to clear global jsPsych preload_request list, even when they've all succeeded\n        this.jsPsych.pluginAPI.cancelPreloads();\n        success = true;\n        end_trial();\n      }\n    };\n\n    // called if all_files haven't finished loading when max_load_time is reached\n    const on_timeout = () => {\n      this.jsPsych.pluginAPI.cancelPreloads();\n      if (typeof success !== \"undefined\" && (success === false || success === null)) {\n        timeout = true;\n        if (loaded_success < total_n) {\n          success = false;\n        }\n        after_error(\"timeout\"); // call trial's on_error event handler here, in case loading timed out with no file errors\n        detailed_errors.push(\n          \"<p><strong>Loading timed out.</strong><br>\" +\n            \"Consider compressing your stimuli files, loading your files in smaller batches,<br>\" +\n            \"and/or increasing the <i>max_load_time</i> parameter.</p>\"\n        );\n        if (trial.continue_after_error) {\n          end_trial();\n        } else {\n          stop_with_error_message();\n        }\n      }\n    };\n\n    const stop_with_error_message = () => {\n      this.jsPsych.pluginAPI.clearAllTimeouts();\n      this.jsPsych.pluginAPI.cancelPreloads();\n      // show error message\n      display_element.innerHTML = trial.error_message;\n      // show detailed errors, if necessary\n      if (trial.show_detailed_errors) {\n        display_element.innerHTML += \"<p><strong>Error details:</strong></p>\";\n        detailed_errors.forEach((e) => {\n          display_element.innerHTML += e;\n        });\n      }\n    };\n\n    const end_trial = () => {\n      // clear timeout again when end_trial is called, to handle race condition with max_load_time\n      this.jsPsych.pluginAPI.clearAllTimeouts();\n      var trial_data = {\n        success: success,\n        timeout: timeout,\n        failed_images: failed_images,\n        failed_audio: failed_audio,\n        failed_video: failed_video,\n      };\n      // clear the display\n      display_element.innerHTML = \"\";\n      this.jsPsych.finishTrial(trial_data);\n    };\n\n    // do preloading\n\n    if (trial.max_load_time !== null) {\n      this.jsPsych.pluginAPI.setTimeout(on_timeout, trial.max_load_time);\n    }\n\n    var total_n = images.length + audio.length + video.length;\n    var loaded = 0; // success or error count\n    var loaded_success = 0; // success count\n\n    if (total_n == 0) {\n      on_success();\n    } else {\n      const load_video = (cb) => {\n        this.jsPsych.pluginAPI.preloadVideo(video, cb, file_loading_success, file_loading_error);\n      };\n      const load_audio = (cb) => {\n        this.jsPsych.pluginAPI.preloadAudio(audio, cb, file_loading_success, file_loading_error);\n      };\n      const load_images = (cb) => {\n        this.jsPsych.pluginAPI.preloadImages(images, cb, file_loading_success, file_loading_error);\n      };\n      if (video.length > 0) {\n        load_video(() => {});\n      }\n      if (audio.length > 0) {\n        load_audio(() => {});\n      }\n      if (images.length > 0) {\n        load_images(() => {});\n      }\n    }\n\n    // helper functions and callbacks\n\n    // called when a single file loading fails\n    function file_loading_error(e) {\n      // update progress bar even if there's an error\n      update_loading_progress_bar();\n      // change success flag after first file loading error\n      if (success == null) {\n        success = false;\n      }\n      // add file to failed media list\n      var source = \"unknown file\";\n      if (e.source) {\n        source = e.source;\n      }\n      if (e.error && e.error.path && e.error.path.length > 0) {\n        if (e.error.path[0].localName == \"img\") {\n          failed_images.push(source);\n        } else if (e.error.path[0].localName == \"audio\") {\n          failed_audio.push(source);\n        } else if (e.error.path[0].localName == \"video\") {\n          failed_video.push(source);\n        }\n      }\n      // construct detailed error message\n      var err_msg = \"<p><strong>Error loading file: \" + source + \"</strong><br>\";\n      if (e.error.statusText) {\n        err_msg += \"File request response status: \" + e.error.statusText + \"<br>\";\n      }\n      if (e.error == \"404\") {\n        err_msg += \"404 - file not found.<br>\";\n      }\n      if (\n        typeof e.error.loaded !== \"undefined\" &&\n        e.error.loaded !== null &&\n        e.error.loaded !== 0\n      ) {\n        err_msg += e.error.loaded + \" bytes transferred.\";\n      } else {\n        err_msg +=\n          \"File did not begin loading. Check that file path is correct and reachable by the browser,<br>\" +\n          \"and that loading is not blocked by cross-origin resource sharing (CORS) errors.\";\n      }\n      err_msg += \"</p>\";\n      detailed_errors.push(err_msg);\n      // call trial's on_error function\n      after_error(source);\n      // if this is the last file\n      if (loaded == total_n) {\n        if (trial.continue_after_error) {\n          // if continue_after_error is false, then stop with an error\n          end_trial();\n        } else {\n          // otherwise end the trial and continue\n          stop_with_error_message();\n        }\n      }\n    }\n\n    // called when a single file loads successfully\n    function file_loading_success(source: string) {\n      update_loading_progress_bar();\n      // call trial's on_success function\n      after_success(source);\n      loaded_success++;\n      if (loaded_success == total_n) {\n        // if this is the last file and all loaded successfully, call success function\n        on_success();\n      } else if (loaded == total_n) {\n        // if this is the last file and there was at least one error\n        if (trial.continue_after_error) {\n          // end the trial and continue with experiment\n          end_trial();\n        } else {\n          // if continue_after_error is false, then stop with an error\n          stop_with_error_message();\n        }\n      }\n    }\n\n    function after_error(source: string) {\n      // call on_error function and pass file name\n      if (trial.on_error !== null) {\n        trial.on_error(source);\n      }\n    }\n    function after_success(source: string) {\n      // call on_success function and pass file name\n      if (trial.on_success !== null) {\n        trial.on_success(source);\n      }\n    }\n  }\n\n  simulate(\n    trial: TrialType<Info>,\n    simulation_mode,\n    simulation_options: any,\n    load_callback: () => void\n  ) {\n    if (simulation_mode == \"data-only\") {\n      load_callback();\n      this.simulate_data_only(trial, simulation_options);\n    }\n    if (simulation_mode == \"visual\") {\n      this.simulate_visual(trial, simulation_options, load_callback);\n    }\n  }\n\n  private create_simulation_data(trial: TrialType<Info>, simulation_options) {\n    const default_data = {\n      success: true,\n      timeout: false,\n      failed_images: [],\n      failed_audio: [],\n      failed_video: [],\n    };\n\n    const data = this.jsPsych.pluginAPI.mergeSimulationData(default_data, simulation_options);\n\n    return data;\n  }\n\n  private simulate_data_only(trial: TrialType<Info>, simulation_options) {\n    const data = this.create_simulation_data(trial, simulation_options);\n\n    this.jsPsych.finishTrial(data);\n  }\n\n  private simulate_visual(trial: TrialType<Info>, simulation_options, load_callback: () => void) {\n    const display_element = this.jsPsych.getDisplayElement();\n\n    this.trial(display_element, trial);\n    load_callback();\n  }\n}\n\nexport default PreloadPlugin;\n"],"names":[],"mappings":"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"}